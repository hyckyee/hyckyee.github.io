<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>병점스토리 파일공유</title>
    <style>
        /* CSS 스타일 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 20px;
        }
        header {
            background-color: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
        }
        nav {
            background-color: #444;
            padding: 10px;
            text-align: center;
        }
        nav a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
        }
        nav a:hover {
            text-decoration: underline;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #fileList {
            list-style: none;
            padding: 0;
        }
        #fileList li {
            margin-bottom: 10px;
        }
        #fileList li a {
            display: inline-block;
            text-decoration: none;
            padding: 5px 10px;
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            color: #333;
        }
        #fileList li a:hover {
            background-color: #e9e9e9;
        }
        #fileInput {
            display: none;
        }
        #uploadLabel {
            display: inline-block;
            background-color: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>병점스토리 파일공유</h1>
    </header>
    <nav>
        <a href="#" id="homeLink">홈</a>
        <a href="#" id="announcementLink">급식</a>
        <a href="#" id="schoolInfoLink">시간표</a>
        <a href="#" id="communityLink">커뮤니티(베타)</a>
    </nav>
    <div class="container">
        <h1>병점스토리 파일공유</h1>
        <p>파일 이름에는 영문, 숫자, 특수 기호만을 사용할 수 있습니다.</p>
        <label for="fileInput" id="uploadLabel">파일 선택</label>
        <input type="file" id="fileInput" style="display: none;">
        <ul id="fileList"></ul>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.4/firebase-app.js';
        import { getFirestore, serverTimestamp, collection, addDoc, getDocs, orderBy, query } from 'https://www.gstatic.com/firebasejs/9.6.4/firebase-firestore.js';
        import { getStorage, ref, uploadBytes } from 'https://www.gstatic.com/firebasejs/9.6.4/firebase-storage.js';

        document.addEventListener('DOMContentLoaded', async function() {
            const firebaseConfig = {
                apiKey: "AIzaSyCYBpnsvR8DpS8VxsVEFp7rahCJx4YWu4c",
            authDomain: "byeongjeomstory.firebaseapp.com",
            databaseURL: "https://byeongjeomstory-default-rtdb.firebaseio.com",
            projectId: "byeongjeomstory",
            storageBucket: "byeongjeomstory.appspot.com",
            messagingSenderId: "413439246892",
            appId: "1:413439246892:web:abcd1e13e6d445c4670789",
            measurementId: "G-VMVXF8JGZS"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const storage = getStorage(app);

            const fileInput = document.getElementById('fileInput');
            const fileListContainer = document.getElementById('fileList');

            // 파일 목록 업데이트 함수
            async function updateFileList() {
                fileListContainer.innerHTML = ''; // 이전 목록 제거
                const q = query(collection(db, "files"), orderBy('timestamp', 'desc')); // 최신순으로 정렬된 쿼리
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    const fileData = doc.data();
                    const fileName = fileData.name;
                    const fileSize = fileData.size;
                    const downloadURL = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/files%2F${encodeURIComponent(fileName)}?alt=media`;
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = downloadURL;
                    link.textContent = `${fileName} (${fileSize} bytes)`;
                    listItem.appendChild(link);
                    
                    // "신고" 버튼 추가
                    const reportButton = document.createElement('button');
                    reportButton.textContent = '신고';
                    reportButton.addEventListener('click', () => {
                        reportFile(fileName);
                    });
                    listItem.appendChild(reportButton);
                    
                    fileListContainer.appendChild(listItem);
                });
            }

            // 파일 신고 함수
            async function reportFile(fileName) {
                // Firestore에 파일 정보 저장
                try {
                    await addDoc(collection(db, "reports"), {
                        fileName: fileName,
                        reportedAt: serverTimestamp()
                    });
                    console.log('파일 신고됨:', fileName);
                    alert('파일이 신고되었습니다.');
                } catch (error) {
                    console.error("파일 신고 오류: ", error);
                    alert('파일 신고 중 오류가 발생했습니다.');
                }
            }

            // 파일 업로드 함수
            async function uploadFile(file) {
                const fileName = file.name;
                const fileSize = file.size;

                try {
                    // Firebase Storage에 파일 업로드
                    const storageRef = ref(storage, `files/${fileName}`);
                    await uploadBytes(storageRef, file);

                    // Firestore에 파일 정보 저장
                    await addDoc(collection(db, "files"), {
                        name: fileName,
                        size: fileSize,
                        timestamp: serverTimestamp()
                    });

                    // 파일 목록 업데이트
                    updateFileList();

                    // 파일 업로드 완료 메시지 표시
                    alert('파일이 업로드되었습니다.');
                } catch (error) {
                    console.error("파일 업로드 오류: ", error);
                    alert('파일 업로드 중 오류가 발생했습니다.');
                }
            }

            // 파일 선택 시 업로드 함수 호출
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    uploadFile(file);
                }
            });

            // 파일 목록 업데이트
            updateFileList();
        });
    </script>
</body>
</html>
